# ビルド＆デプロイに関するルール

## Overview

デプロイに関するルールを定義する。
デプロイの方法やバージョン番号のルールなどなど。

## Rule

### CI導入

基本的にはCIを導入し、デプロイの自動化を心がけること。
CIとしては特に理由がなければAWSのCodePipeline, CodeBuild, CodeDeployを利用する。
AWSで完結した方が構築が楽。

### フロントとバックの連携が必要なデプロイ

フロントとバックエンドで連携が必要な更新がある場合がある。
（例えばjsonのschemeが変更されるなど)

変更の度合いでデプロイの形を切り替える。

#### そもそもエンドポイントが変わる場合

Majorバージョンをインクリメントして、パラメータパスを変える。
`xxx.com/v1` -> `xxx.com/v2`

#### jsonのSchemeが大きく変わる場合

1. 古いエンドポイントをdeprecatedにする。（消さない)
2. 新しいエンドポイントを作成する。
3. Majorバージョンが上がるタイミングでdeprecatedのエンドポイントを整理して削除する。

#### jsonのSchemeが小さく変わる場合

この場合、クライアント側での更新とバックエンド側での更新のギャップがダウンタイムになってしまう。
なので、バックエンド側でヘッダーパラメータによる処理の切り替えを一回はさむことでダウンタイムをなくす。

1. クライアントからのリクエストヘッダにマイナーバージョンを`x-minor-version`で指定してもらう。
2. バックエンド側でx-minor-versionの値を確認して、新旧どちらにも対応する形にバックエンドを修正する。
3. フロントエンド側で新しい処理を実装し、その際にヘッダーに`x-minor-version`を新しいバージョン番号で指定する。
4. フロントエンド側で更新を終えたら、バックエンド側の処理を新しいもののみに統一する。
